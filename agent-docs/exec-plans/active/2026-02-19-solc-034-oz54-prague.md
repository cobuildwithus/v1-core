# Solc 0.8.34 + OZ 5.4 + Prague + Revnet Harness Deislanding

Status: active
Created: 2026-02-19
Updated: 2026-02-19

## Goal

- Move this repo to a consistent Solidity/OZ baseline (`solc 0.8.34`, OpenZeppelin `5.4.0`, `evm_version = prague`)
  while removing the last local `0.8.23` test harness island by replacing it with a local
  `^0.8.34` Revnet ruleset simulator.

## Success criteria

- No non-lib files are pinned to `pragma solidity 0.8.23`.
- Goal/Revnet integration tests still validate mint-open/mint-closed behaviors and deadline derivation.
- Dependency graph uses OpenZeppelin `5.4.0` for both base and upgradeable packages.
- Foundry build/test commands pass with `solc 0.8.34` and `evm_version = prague`.
- Existing behavior regressions are either fixed or explicitly documented as intended.

## Scope

- In scope:
  - Replace `test/goals/helpers/RevnetTestHarness.sol` dependency on concrete Nana `JBRulesets` with local simulator.
  - Update harness deploy path to direct deployment (remove artifact prebuild dependency).
  - Update compiler config (`foundry.toml`) and local pragmas (`^0.8.34`) where applicable.
  - Upgrade OZ package versions to `5.4.0` and refresh lockfile.
  - Add/adjust tests for replacement harness edge semantics.
- Out of scope:
  - Modifying `lib/**` submodules.
  - Protocol logic redesign beyond compatibility fixes required by compiler/dependency changes.
  - Superfluid or Nana upstream version upgrades.

## Constraints

- Technical constraints:
  - Keep imports on canonical interfaces from `@bananapus/core-v5`.
  - Preserve GoalTreasury and GoalStakeVault assumptions around ruleset timeline.
  - Avoid destructive git operations in dirty workspace.
- Product/process constraints:
  - Run `forge build -q` and `pnpm -s test:lite` before completion.
  - Keep plan/doc references updated for multi-file work.

## Risks and mitigations

1. Risk: Local simulator diverges from canonical `JBRulesets` semantics relied on by integrations.
   Mitigation: Implement only required method surface and add boundary tests around `currentOf`/deadline logic.
2. Risk: Compiler/dependency bump introduces subtle OZ API/behavior shifts.
   Mitigation: Run targeted Goal/Hook suites first, then full lite suite; patch regressions immediately.
3. Risk: Dirty worktree may obscure migration diffs.
   Mitigation: Limit edits to scoped files and report exact touched paths in final summary.

## Tasks

1. Replace Revnet test harness with local `IJBRulesets` simulator under `^0.8.34`.
2. Update fixture/deployer paths to deploy harness directly, remove prebuild artifact flow.
3. Bump pragmas/config to `0.8.34` and set `evm_version = prague`.
4. Upgrade OpenZeppelin deps to `5.4.0` and refresh lockfile.
5. Execute targeted + broad test matrix and fix regressions.
6. Summarize migration decisions and residual risks.

## Decisions

- Use test-local ruleset simulator instead of forking concrete Nana `JBRulesets`.
- Keep canonical Bananapus interfaces (`IJBRulesets`, `IJBDirectory`) in tests while removing concrete
  `JBRulesets` dependency.
- Remove artifact prebuild path for Revnet harness and deploy test harness directly from Solidity.

## Progress notes

- Implemented `RevnetTestRulesets` (test-local `IJBRulesets` simulator) and rewired `RevnetTestHarness` to use it.
- Updated `RevnetHarnessDeployer` to deploy `new RevnetTestHarness()` directly.
- Added mint-close boundary smoke coverage in `GoalRevnetIntegration.t.sol` for `latestQueuedOf/getRulesetOf/currentOf`.
- Hardened `RevnetTestRulesets` to reject out-of-range queue params and return empty `currentOf` when no ruleset has
  started yet.
- Added smoke coverage for external `queueFor` rejection, unconfigured `latestQueuedOf`, no-start `currentOf`, and
  queue value bounds.
- Bumped Foundry config to `solc = 0.8.34` and `evm_version = "prague"`.
- Bumped OpenZeppelin deps to `5.4.0` and refreshed `pnpm-lock.yaml`.
- Updated all local `^0.8.28` pragmas to `^0.8.34`.

## Verification

- Commands to run:
  - `forge build -q`
  - `forge test -q --match-path test/goals/GoalRevnetIntegration.t.sol`
  - `forge test -q --match-path test/goals/GoalRevnetSplitHook.t.sol`
  - `pnpm -s test:lite`
- Expected outcomes:
  - All commands exit `0` with no compiler-version mismatch errors.

## Verification outcomes

- `forge build -q` passed with Solc `0.8.34`.
- `forge test -q --match-path test/goals/GoalRevnetIntegration.t.sol` passed.
- `forge test -q --match-path test/goals/GoalRevnetSplitHook.t.sol` passed.
- `pnpm -s test:lite` passed: `515 passed, 0 failed`.
- `forge test -q` passed (full suite, including invariant paths).
- `pnpm -s test:coverage:ci` passed: `531 passed, 0 failed`; coverage unchanged at
  lines `93.99%` and branches `89.15%`.
